<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Invoice</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  :root{
    --bg:#f6f7f8; --paper:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --accent:#2f2f2f;
  }
  *{ box-sizing:border-box }
  html,body{ height:auto; min-height:100%; }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:14px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    -webkit-print-color-adjust:exact; print-color-adjust:exact;
  }

  .sheet{
    width:900px; max-width:95vw; margin:22px auto;
    background:var(--paper); border:1px solid var(--line); border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.05);
    padding:28px 32px 26px;
  }

  /* Header */
  .header{ display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center }
  .brand{ display:flex; gap:12px; align-items:center }
  .logo{ width:56px; height:56px; border:1px solid var(--line); border-radius:12px; display:grid; place-items:center; overflow:hidden; background:#fff }
  .logo img{ max-width:100%; max-height:100%; object-fit:contain }
  .t1{ font-size:20px; font-weight:800; letter-spacing:.02em }
  .t2{ font-size:12px; color:var(--muted); margin-top:2px }
  .inv-title{ font-size:32px; letter-spacing:.04em; font-weight:900; color:var(--accent) }

  /* Slim black→grey progress bar */
  .divider{
    height:3px;
    background:linear-gradient(90deg, var(--accent) 0 15%, #c7c9cc 15% 100%);
    border-radius:3px;
    margin:12px 0 4px;
  }
  /* top-right site text — now hidden per request */
  .site{ display:none; }

  /* Top meta */
  .meta{ display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:8px }
  .box{ border:1px solid var(--line); border-radius:10px; padding:14px 16px; background:#fff }
  .box h4{ margin:0 0 8px; font-size:13px; text-transform:uppercase; letter-spacing:.06em; color:#4b5563 }
  .mtitle{ font-weight:800; font-size:18px; margin:0 0 6px }
  .kv{ display:grid; grid-template-columns:140px 1fr; gap:6px 12px; font-size:13px }
  .label{ color:var(--muted) }

  .meta-plain{ border:none; background:transparent; padding:0; text-align:right; }
  .meta-plain .kv{ grid-template-columns:1fr 140px; margin-top:4px }
  .desc{ margin-top:8px; font-size:13px; color:#374151; text-align:right }

  /* Items */
  h3.section{ margin:18px 0 10px; font-size:16px; font-weight:800; letter-spacing:.02em; text-align:center }
  table{ width:100%; border-collapse:collapse; }
  thead th{
    text-transform:uppercase; letter-spacing:.05em; font-size:11px; color:#4b5563;
    border-bottom:2px solid var(--accent); padding:8px 10px; background:#f3f4f6; text-align:center;
  }
  tbody td{ padding:10px; border-bottom:1px solid #eceff1; text-align:center; vertical-align:middle }
  tbody td.desc-cell{ text-align:left }
  tbody tr:nth-child(2n){ background:#fafafa }
  td.num{ white-space:nowrap }

  /* Totals & payment */
  .totals{ display:grid; grid-template-columns:1fr 260px; gap:16px; margin-top:16px; align-items:start }
  .pay{ border:1px solid var(--line); border-radius:10px; padding:12px 14px; background:#fff }
  .pay h5{ margin:0 0 8px; font-weight:800; letter-spacing:.06em; text-transform:uppercase; font-size:12px; color:#4b5563 }
  .pay p{ margin:0; font-size:13px }
  .sum{ border:1px solid var(--line); border-radius:10px; background:#fff; padding:12px 14px }
  .sum .row{ display:flex; justify-content:space-between; margin:4px 0; }
  .sum .row .label{ color:#6b7280 }
  .grand{ margin-top:8px; background:#111827; color:#fff; padding:12px 14px; border-radius:10px; font-weight:900; display:flex; justify-content:space-between }

  /* Thanks & signature */
  .thanks{ margin-top:16px; font-weight:700 }
  .terms{ margin-top:6px; font-size:13px; color:#4b5563 }
  .sigwrap{ display:flex; justify-content:flex-end; gap:28px; align-items:flex-end; margin-top:24px }
  .sigline{ width:240px; border-bottom:1px solid #d1d5db; height:50px }
  .sigmeta{ text-align:right; font-size:12px; color:#4b5563 }

  /* Footer */
  .footer{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:18px; padding-top:14px; border-top:1px solid #e5e7eb; color:#374151 }
  .footer div{ display:flex; align-items:center; gap:10px; }
  .icon{ width:24px; height:24px; border:1px solid #d1d5db; border-radius:50%; display:grid; place-items:center; }
  .icon svg{ width:14px; height:14px; stroke:#6b7280; fill:none; stroke-width:2; }
  .footer small{ font-size:12px }

  /* Print */
  @page { size: A4; margin: 10mm; }
  thead{ display:table-header-group }
  tfoot{ display:table-footer-group }
  @media print{
    body{ background:#fff }
    .sheet{ width: 190mm; margin:0 auto; box-shadow:none; border:none; padding:0 0 6mm 0; }
    /* keep gradient bar in print — no override */
    .footer small{ font-size:11px }
    .sheet{ page-break-after:auto; }
  }

  /* Print */
  @page { size: A4; margin: 10mm; }
  thead{ display:table-header-group }
  tfoot{ display:table-footer-group }

  @media print{
    body{ background:#fff }
    .sheet{ width: 190mm; margin:0 auto; box-shadow:none; border:none; padding:0 0 6mm 0; }
    /* keep gradient bar in print — no override */
    .footer small{ font-size:11px }
    .sheet{ page-break-after:auto; }
  }

  /* ===== MOBILE PRINT PATCH (iOS) ===== */
  @page { size: A4; margin: 6mm; } /* ajusta margem */
  @media print {
    .sheet{
      width: calc(210mm - 12mm);
      margin: 0 auto;
      padding: 4mm 4mm 6mm;
      border: none;
      box-shadow: none;
      page-break-inside: avoid;
    }
    body{ font-size: 13px; }
    table thead th{ font-size: 10px; }
    tbody td{ padding: 8px; }
  }
  @supports (-webkit-touch-callout: none) {
    @media print {
      .sheet{
        width: calc(210mm - 10mm);
        padding: 4mm;
      }
    }
  }
</style>

  
</head>
<body>
  <div class="sheet">
    <header class="header">
      <div class="brand">
        <div class="logo" id="from_logo_box"></div>
        <div>
          <div class="t1" id="brand_name">Company</div>
          <div class="t2" id="brand_sub"></div>
        </div>
      </div>
      <div class="right"><div class="inv-title" id="inv_title">INVOICE</div></div>
    </header>
    <div class="divider"></div>
    <div class="site" id="brand_site"></div>

    <section class="meta">
      <!-- CLIENT -->
      <div class="box">
        <h4>Invoice To :</h4>
        <div class="mtitle" id="client_name"></div>
        <div class="kv" style="margin-top:6px">
          <div class="label">Phone</div><div id="client_phone"></div>
          <div class="label">Email</div><div id="client_email"></div>
          <div class="label">Website</div><div id="client_website"></div>
        </div>
        <div class="kv" style="margin-top:10px">
          <div class="label">Business Number</div><div id="client_business_number"></div>
          <div class="label">Address</div><div id="client_address"></div>
        </div>
      </div>

      <!-- INVOICE META (borderless) -->
      <div class="box meta-plain">
        <div class="kv">
          <div class="label">Invoice no :</div><div id="invoice_number"></div>
          <div class="label">Date :</div><div id="invoice_date"></div>
        </div>
        <h4 style="margin:10px 0 4px; text-transform:none; letter-spacing:0; font-weight:700; text-align:right">Invoice Description</h4>
        <div class="desc" id="invoice_description"></div>
      </div>
    </section>

    <h3 class="section">Items</h3>
    <table>
      <thead>
        <tr>
          <th style="width:130px">Date of Work</th>
          <th>Description</th>
          <th style="width:120px">Price / Hourly Rate</th>
          <th style="width:80px">Cost Qty</th>
          <th style="width:140px">Cost Total</th>
        </tr>
      </thead>
      <tbody id="items_body"></tbody>
    </table>

    <section class="totals">
      <div class="pay">
        <h5>Payment Method :</h5>
        <p><strong>Company ABN</strong> : <span id="company_abn"></span></p>
        <p><strong>Bank Name</strong> : <span id="bank_name"></span></p>
        <p><strong>Account Name</strong> : <span id="bank_acc_name"></span></p>
        <p><strong>Account Number</strong> : <span id="bank_acc_no"></span></p>
        <p><strong>Account BSB</strong> : <span id="bank_bsb"></span></p>
      </div>
      <div class="sum">
        <div class="row"><div class="label">Total Hours :</div><div id="total_hours">0</div></div>
        <div class="row"><div class="label">Sub Total :</div><div id="subtotal">$0.00</div></div>
        <div class="row"><div class="label">GST <span id="tax_rate_label"></span> :</div><div id="taxes">$0.00</div></div>
        <div class="grand"><div>Grand Total :</div><div id="grand_total">$0.00</div></div>
      </div>
    </section>

    <div class="thanks">Thank you for your business!</div>
    <div class="terms" id="terms"></div>

    <div class="sigwrap" id="sign_block">
      <div class="sigline"></div>
      <div class="sigmeta">
        <div style="font-weight:700; margin-top:8px" id="signer"></div>
      </div>
    </div>

    <footer class="footer">
      <div>
        <span class="icon">
          <svg viewBox="0 0 24 24"><path d="M2 3h4l2 5-3 2a16 16 0 0 0 7 7l2-3 5 2v4a2 2 0 0 1-2 2c-9.94 0-18-8.06-18-18a2 2 0 0 1 2-2z"/></svg>
        </span> <small id="from_phone_footer"></small>
      </div>
      <div>
        <span class="icon">
          <svg viewBox="0 0 24 24"><path d="M4 4h16a2 2 0 0 1 2 2v0l-10 7L2 6v0a2 2 0 0 1 2-2z"/><path d="M22 8l-10 7L2 8"/></svg>
        </span> <small id="from_email_footer"></small>
      </div>
      <div>
        <span class="icon">
          <svg viewBox="0 0 24 24"><path d="M12 21s7-4.35 7-10a7 7 0 0 0-14 0c0 5.65 7 10 7 10z"/><circle cx="12" cy="11" r="3"/></svg>
        </span> <small id="from_address_footer"></small>
      </div>
    </footer>
  </div>

<script>
  // ---- helpers
  const qp = new URLSearchParams(location.search);
  const get = (k, d='') => qp.get(k) ?? d;
  const ccy = get('ccy','AUD');

  const clean = v => {
    if(v==null||v==='') return 0;
    const n = parseFloat(String(v).replace(/[^0-9.-]/g,'')); return isNaN(n)?0:n;
  };
  const money = n => Number(n||0).toLocaleString(undefined,{style:'currency',currency:ccy});
  const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function setText(id, value){
    const el = document.getElementById(id); if(!el) return;
    if(value && String(value).trim()!==''){ el.textContent = value; el.style.display=''; }
    else { el.textContent = ''; el.style.display='none'; }
  }

  // Header brand
  const brand = get('from_name','');
  setText('brand_name', brand || 'Invoice');
  setText('brand_sub', get('from_web',''));
  // top-right is hidden via CSS, but we won't fill it either:
  setText('brand_site','');

  // Logo
  const logo = get('from_logo','').trim();
  if (logo) { document.getElementById('from_logo_box').innerHTML = `<img src="${logo}" alt="logo">`; }

  // Title + invoice number
  setText('inv_title', 'INVOICE');
  setText('invoice_number', get('invoice_number',''));

  // Date formatting
  (function(){
    const raw = get('invoice_date',''); let out = raw;
    const d = new Date(raw);
    if (!isNaN(d.getTime())) {
      const day = String(d.getDate()).padStart(2,'0');
      const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      out = `${day} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }
    setText('invoice_date', out);
  })();

  // Client
  setText('client_name', get('client_name',''));
  setText('client_phone', get('client_phone',''));
  setText('client_email', get('client_email',''));
  setText('client_website', get('client_website',''));
  setText('client_business_number', get('client_business_number',''));
  setText('client_address', get('client_address',''));

  // Description
  setText('invoice_description', get('invoice_description',''));

  // Payment / bank
  setText('company_abn', get('from_business_no',''));
  setText('bank_name', get('bank_name',''));
  setText('bank_acc_name', get('bank_acc_name',''));
  setText('bank_acc_no', get('bank_acc_no',''));
  const bsb = get('bank_bsb','') || get('bank_routing','');
  setText('bank_bsb', bsb);

  // Footer contact from company
  setText('from_phone_footer', get('from_phone',''));
  setText('from_email_footer', get('from_email',''));
  setText('from_address_footer', get('from_address',''));

  // Items parser — rows: (date?)::title::price::qty::total
  function parseItems(str){
    if(!str) return [];
    const rowSep = /(\|\||%7C%7C)/i, colSep = /(::|%3A%3A)/i;
    return str.split(rowSep).filter(s => !rowSep.test(s) && s!=='')
      .map(row => {
        const parts = row.split(colSep).filter(s => !colSep.test(s));
        let date='', title='', price='', qty='', total='';
        if(parts.length === 5){ [date,title,price,qty,total] = parts; }
        else { [title,price,qty,total] = parts; }
        return {
          date: decodeURIComponent(date || ''),
          title: decodeURIComponent(title || ''),
          price: clean(price),
          qty: parseFloat(qty || 0) || 0,
          total: clean(total)
        };
      });
  }

  const items = parseItems(get('items',''));
  const tbody = document.getElementById('items_body');
  let subtotalFromItems = 0;
  items.forEach(it => {
    subtotalFromItems += it.total || 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(it.date)}</td>
      <td class="desc-cell">${esc(it.title)}</td>
      <td class="num">${money(it.price)}</td>
      <td>${(it.qty ?? 0).toLocaleString()}</td>
      <td class="num">${money(it.total)}</td>`;
    tbody.appendChild(tr);
  });

  // Totals + hours
  setText('total_hours', get('total_hours',''));

  let subtotal = clean(get('subtotal',''));
  if (!subtotal && subtotalFromItems) subtotal = subtotalFromItems;

  let taxRate = get('tax_rate','');
  taxRate = taxRate === '' ? '' : Number(String(taxRate).replace('%',''));
  if (taxRate && taxRate > 1) taxRate = taxRate / 100;

  let taxes = clean(get('taxes',''));
  if (!taxes && typeof taxRate === 'number' && !isNaN(taxRate)) taxes = subtotal * taxRate;

  let grand = clean(get('grand_total',''));
  if (!grand) grand = subtotal + taxes;

  setText('subtotal', money(subtotal));
  setText('taxes', money(taxes));
  document.getElementById('tax_rate_label').textContent =
    (taxRate || taxRate===0) ? `(${(taxRate*100).toFixed(0)}%)` : '';
  setText('grand_total', money(grand));

  // Signature
  const signerText = [get('signer_name','').trim(), get('signer_role','').trim()].filter(Boolean).join(' · ');
  if (signerText) document.getElementById('signer').textContent = signerText;
  else document.getElementById('sign_block').style.display = 'none';

  // Terms (optional)
  const terms = get('terms','').trim();
  if(terms) document.getElementById('terms').textContent = terms;
  else document.getElementById('terms').style.display = 'none';

  // Auto-print
  const autoPrint = /^(1|true)$/i.test(get('print','').trim());
  if (autoPrint) {
    window.addEventListener('load', () => { try { setTimeout(() => window.print(), 0); } catch {} });
  }

  // ===== Hide titles/labels when values are empty (non-invasive add-on) =====

// Hide the <div class="label"> immediately before a value cell in a .kv grid
function hideKVLabelIfEmpty(id){
  const v = document.getElementById(id);
  if(!v) return;
  const isEmpty = (v.textContent || '').trim()==='' || v.style.display==='none';
  if(isEmpty){
    const label = v.previousElementSibling;
    if(label && label.classList && label.classList.contains('label')){
      label.style.display = 'none';
    }
  }
}

// Hide the entire parent line (<p>) in the Payment box if value empty
function hidePaymentLineIfEmpty(id){
  const v = document.getElementById(id);
  if(!v) return;
  const isEmpty = (v.textContent || '').trim()==='' || v.style.display==='none';
  if(isEmpty && v.parentElement){
    v.parentElement.style.display = 'none';
  }
}

// Hide the whole footer column (icon + text) if value empty
function hideFooterColIfEmpty(id){
  const v = document.getElementById(id);
  if(!v) return;
  const isEmpty = (v.textContent || '').trim()==='' || v.style.display==='none';
  if(isEmpty){
    const col = v.closest('div'); // the footer column container
    if(col) col.style.display = 'none';
  }
}

// Apply to KV grids (client + invoice meta)
[
  'client_phone','client_email','client_website',
  'client_business_number','client_address',
  'invoice_number','invoice_date'
].forEach(hideKVLabelIfEmpty);

// Apply to Payment lines (<p> rows)
[
  'company_abn','bank_name','bank_acc_name','bank_acc_no','bank_bsb'
].forEach(hidePaymentLineIfEmpty);

// Apply to Footer columns
[
  'from_phone_footer','from_email_footer','from_address_footer'
].forEach(hideFooterColIfEmpty);

</script>
</body>
</html>
